---
title: "Ana Grisanti - WB STC R Assessment"
---

## Basic Stats

```{r}
rm(list = ls())

#Loading WDI dataset
tag      <- "202311081903"
base_url <- "https://github.com/randrescastaneda/pub_data/raw/"
data_url <- paste0(base_url, tag, "/data/Rtest1/")

wdi <- readr::read_rds(paste0(data_url, "wdi_in1.Rds"))

#Installing necessary packages and libraries
install.packages('doBy')
library('doBy')
library(collapse)
library(dplyr)
library(tidyverse)
```

1.  Summary Statistics of GDP per capita by region

```{r}
#Generating new dataset with summary statistics of GDP per capita, by region and year
rep1_df<- wdi %>% drop_na(gdp)
rep1_df<-rep1_df%>%
   group_by(region, date) %>%
   summarise(N=n(),
             Mean= weighted.mean(gdp,pop),
             SD= sd(gdp),
             Min= min(gdp),
             Max= max(gdp))

#FINAL REPLICATED DATAFRAME
View(rep1_df)

#Checking similarity to original data
org1_df <- readr::read_rds(paste0(data_url, "wdi_summ_out.Rds"))
waldo::compare(rep_gdp_df, org_gdp_df)
```

2.  Aggregate stats

```{r}
#Checking data to replicate 
org2_df<- readr::read_rds(paste0(data_url, "wdi_agg_out.Rds"))

#Generating new dataset with descriptive statistics of gdp, lifeex, and pov_intl
rep2_df<- collap(wdi, by = ~ region + date, 
       custom = list(fmean = .c(lifeex, gdp, pov_intl),
                     fsd = .c(lifeex, gdp, pov_intl),
                     fmax_uw = .c(lifeex, gdp, pov_intl),
                     fmin_uw = .c(lifeex, gdp, pov_intl),
                     fmedian = .c(lifeex, gdp, pov_intl)),
       w = ~ pop)

#Converting the data to long format
rep2_df_gdp <- rep2_df %>%
  gather(estimate, gdp, fmean.gdp:fmedian.gdp, factor_key=TRUE)
rep2_df_lifeex <- rep2_df %>%
  gather(estimate, lifeex, fmean.lifeex:fmedian.lifeex, factor_key = TRUE)
rep2_df_povintl <- rep2_df %>%
  gather(estimate, pov_intl, fmean.pov_intl:fmedian.pov_intl, factor_key = TRUE)

#Keeping only necessary variables
rep2_df_gdp = rep2_df_gdp[c("estimate","region", "date", "pop", "gdp")]
rep2_df_lifeex = rep2_df_lifeex[c("estimate","region", "date", "pop", "lifeex")]
rep2_df_povintl = rep2_df_povintl[c("estimate","region", "date", "pop", "pov_intl")]

#Cleaning up estimate variable
rep2_df_gdp$estimate <- gsub(".*fmean.*", "Mean", rep2_df_gdp$estimate)
rep2_df_gdp$estimate <- gsub(".*fsd.*", "SD", rep2_df_gdp$estimate)
rep2_df_gdp$estimate <- gsub(".*fmin.*", "Min", rep2_df_gdp$estimate)
rep2_df_gdp$estimate <- gsub(".*fmax.*", "Max", rep2_df_gdp$estimate)
rep2_df_gdp$estimate <- gsub(".*fmedian.*", "Median", rep2_df_gdp$estimate)
#Cleaning up estimate variable
rep2_df_lifeex$estimate <- gsub(".*fmean.*", "Mean", rep2_df_lifeex$estimate)
rep2_df_lifeex$estimate <- gsub(".*fsd.*", "SD", rep2_df_lifeex$estimate)
rep2_df_lifeex$estimate <- gsub(".*fmin.*", "Min", rep2_df_lifeex$estimate)
rep2_df_lifeex$estimate <- gsub(".*fmax.*", "Max", rep2_df_lifeex$estimate)
rep2_df_lifeex$estimate <- gsub(".*fmedian.*", "Median", rep2_df_lifeex$estimate)
#Cleaning up estimate variable
rep2_df_povintl$estimate <- gsub(".*fmean.*", "Mean", rep2_df_povintl$estimate)
rep2_df_povintl$estimate <- gsub(".*fsd.*", "SD", rep2_df_povintl$estimate)
rep2_df_povintl$estimate <- gsub(".*fmin.*", "Min", rep2_df_povintl$estimate)
rep2_df_povintl$estimate <- gsub(".*fmax.*", "Max", rep2_df_povintl$estimate)
rep2_df_povintl$estimate <- gsub(".*fmedian.*", "Median", rep2_df_povintl$estimate)

#Merging dataframes
merged <- merge(rep2_df_gdp, rep2_df_lifeex, by=c("estimate","region", "date", "pop"))
rep2_df <- merge(merged, rep2_df_povintl, by=c("estimate","region", "date", "pop"))
rm(merged, rep2_df_, rep2_df_gdp, rep2_df_lifeex, rep2_df_povintl)

#FINAL REPLICATED DATAFRAME
View(rep2_df)

#Checking for similarity with original datagrame
waldo::compare(rep2_df, org2_df)

```

3.  Find outliers

```{r}
org3_df<-readr::read_rds(paste0(data_url, "wdi_outliers_out.Rds"))

#Generating dataset with mean and sd of lifeex, gdp and gini
df_summary <- wdi %>% 
  group_by(date) %>% 
  summarise(gdp.mean = weighted.mean(gdp, pop, na.rm=TRUE),
            gini.mean= weighted.mean(gini, pop, na.rm=TRUE),
            lifeex.mean= weighted.mean(lifeex, pop, na.rm=TRUE),
            gdp.sd = sd(gdp, na.rm=TRUE),
            gini.sd= sd(gini, na.rm=TRUE),
            lifeex.sd= sd(lifeex, na.rm=TRUE))

#Joining original data with summary 
rep3_df <- left_join(wdi, df_summary, by = "date")

#Generating outlier identifying variables
rep3_df <- rep3_df %>%
  mutate(ll_gdp = print(gdp < gdp.mean - 2.5*(gdp.sd))) %>%
  mutate(hl_gdp = print(gdp > gdp.mean + 2.5*(gdp.sd))) %>%
  mutate(ll_gini = print(gini < gini.mean - 2.5*(gini.sd))) %>%
  mutate(hl_gini = print(gini > gini.mean + 2.5*(gini.sd))) %>%
  mutate(ll_lifeex = print(lifeex < lifeex.mean - 2.5*(lifeex.sd))) %>%
  mutate(hl_lifeex = print(lifeex > lifeex.mean + 2.5*(lifeex.sd)))

#Checking for similarity with original datagrame
waldo::compare(rep3_df, org3_df)
```

4.  Poverty measures

```{r}
#Loading the data
l_svy <-readr::read_rds(paste0(data_url, "svy_sim_in1.Rds"))

org4_df <- readr::read_rds(paste0(data_url, "dt_pov_out.Rds"))
```
